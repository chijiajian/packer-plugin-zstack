name: Notify Integration Release (Tag)

on:
  push:
    tags:
      - '*.*.*'

jobs:
  strip-version:
    runs-on: ubuntu-latest
    outputs:
      packer-version: ${{ steps.strip.outputs.packer-version }}
    steps:
      - name: Strip leading v from version tag
        id: strip
        env:
          REF: ${{ github.ref_name }}
        run: |
          echo "packer-version=$(echo "$REF" | sed -E 's/v?([0-9]+\.[0-9]+\.[0-9]+)/\1/')" >> "$GITHUB_OUTPUT"

  notify-release:
    needs: strip-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v3

      - name: Ensure that Docs are Compiled
        run: |
          make generate
          if [[ -z "$(git status -s)" ]]; then
            echo "OK"
          else
            echo "Docs have been updated, but the compiled docs have not been committed."
            echo "Run 'make generate', and commit the result to resolve this error."
            exit 1
          fi

      - name: Perform the Release
        uses: actions/checkout@v3
        with:
          repository: hashicorp/integration-release-action
          path: ./integration-release-action

      - name: Notify Release
        uses: ./integration-release-action
        with:
          integration_identifier: "packer/chijiajian/zstack"
          release_version: ${{ needs.strip-version.outputs.packer-version }}
          release_sha: ${{ github.ref }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
